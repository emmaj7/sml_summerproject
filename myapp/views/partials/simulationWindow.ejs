<!--
Code for the simulation window.

Mikael Glamheden
2019-06-24
-->

  <!-- TO DO:
        - Arrange windows and buttons in a nice way.
        - Make level 1-3. -->

<!-- Uses pixi module for the animation -->
<script src="../node_modules/pixi.js/dist/pixi.min.js"></script>
<script src="../node_modules/socket.io-client/dist/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>

<div class="">
  <h1>Simulation Window</h1>
  <!-- <button onclick="runCar()" type="button">Starta simuleringen</button> -->
</div>

<div class="">
  <script type="text/javascript">
  /*----------------
  THE ANIMATION PART
  ----------------*/
  let type = "WebGL";
  if(!PIXI.utils.isWebGLSupported()){
    type = "canvas"
  }
  PIXI.utils.sayHello(type); // prints to console if everything is working.

  //Aliases
  let Application = PIXI.Application,
  loader = PIXI.loader,
  resources = PIXI.loader.resources,
  Sprite = PIXI.Sprite;

  //Create a Pixi Application
  var window_size = 512;
  let app = new Application({
    width: window_size,         // default: 800
    height: window_size,        // default: 600
    antialias: true,    // default: false
    transparent: false, // default: false
    resolution: 1,      // default: 1
    forceCanvas: false  // force to use drawng API instead of WebGL
  });
  // Change background color
  app.renderer.backgroundColor = 0x061639;

  //Add the canvas that Pixi automatically created for you to the HTML document
  document.body.appendChild(app.view);


  // Variables for the simulation
  let car;
  var PI = 3.1415;
  var x_offset = 50;
  var y_offset = -20;
  var scale_factor = 256/2;
  var x = 0;
  var y = 0;
  var yaw = 0;
  var xp;
  var yp;
  var obj;
  var start = {'x': 0,'y': 0, 'yaw': 0};
  //load an image and run the `setup` function when it's done
  loader
  .add("./images/car2.png")
  .load(setup);
  // This `setup` function will run when the image has loaded
  function setup() {
    // Create the car sprite
    car = new Sprite(resources["./images/car2.png"].texture);
    // Change the sprite's size
    car.scale.x = 0.2;
    car.scale.y = 0.2;
    // // change anchor point
    car.anchor.x = 0.5;
    car.anchor.y = 0.5;
    start = coordinate_transform(start.x, start.y, start.yaw);
    car.position.set(start.x,start.y);
    car.rotation = start.yaw;
    // Add the cat to the stage
    app.stage.addChild(car);
  }
 // transforms between "true" coordinate system and browser window coordinates
  function coordinate_transform(x, y, yaw){
    var coords = {};
    coords.x = scale_factor*x + x_offset;
    coords.y = window_size - scale_factor*y + y_offset; // y = 0 is upper corner
    coords.yaw = -yaw;
    return coords;
  }
  function runCar(){
    var socket = io();
    socket.on('connect',function(){
      console.log('Connected');
      console.log('Session id: ' + unique_id);
      socket.emit('button pressed', unique_id); // Unique id for each html page opened.
    });
    socket.on('position sent', function(msg){
      // console.log(msg);
      obj = JSON.parse(msg);
      x = obj.x;
      y = obj.y;
      yaw = obj.yaw;
    });
    socket.on('close', function(){
      // Connection was closed.
      console.log('Connection closed');
      socket.disconnect(true); // close connection to server.
    });
    app.ticker.add(delta => drive(delta));
    // This function is run at 60 Hz. Defined by app.ticker.
    function drive(){
      var coords = coordinate_transform(x, y, yaw);
      car.position.set(coords.x, coords.y);
      car.rotation = coords.yaw;
    }
  }

  </script>
</div>
